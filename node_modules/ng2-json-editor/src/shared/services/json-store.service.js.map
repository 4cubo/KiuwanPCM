{"version":3,"sources":["../../../../staging/src/shared/services/json-store.service.ts"],"names":[],"mappings":"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","file":"json-store.service.js","sourceRoot":"","sourcesContent":["/*\n * This file is part of ng2-json-editor.\n * Copyright (C) 2016 CERN.\n *\n * ng2-json-editor is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License as\n * published by the Free Software Foundation; either version 2 of the\n * License, or (at your option) any later version.\n *\n * ng2-json-editor is distributed in the hope that it will be useful, but\n * WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n * General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with ng2-json-editor; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.\n * In applying this license, CERN does not\n * waive the privileges and immunities granted to it by virtue of its status\n * as an Intergovernmental Organization or submit itself to any jurisdiction.\n*/\n\nimport { Injectable } from '@angular/core';\nimport { Map, List, fromJS } from 'immutable';\nimport { ReplaySubject } from 'rxjs/ReplaySubject';\nimport { Subject } from 'rxjs/Subject';\n\nimport { PathUtilService } from './path-util.service';\nimport { KeysStoreService } from './keys-store.service';\nimport { JsonPatch, JsonPatchesByPath } from '../interfaces';\nimport { SizedStack } from '../classes';\n\n\nexport class JsonStoreService {\n\n  readonly patchesByPath$ = new ReplaySubject<JsonPatchesByPath>(1);\n  readonly json$ = new Subject<Map<string, any>>();\n  readonly jsonPatches$ = new Subject<Array<JsonPatch>>();\n\n  private patchesByPath: JsonPatchesByPath = {};\n  private json: Map<string, any>;\n  private jsonPatches: Array<JsonPatch>;\n\n  // list of reverse patches for important changes\n  private history = new SizedStack<JsonPatch>(5);\n\n  constructor(private pathUtilService: PathUtilService,\n    private keysStoreService: KeysStoreService) { }\n\n  setIn(path: Array<any>, value: any, allowUndo = true) {\n    if (value === '' || value === undefined) {\n      this.removeIn(path);\n      return;\n    }\n\n    value = this.toImmutable(value);\n\n    // immutablejs setIn creates Map for keys that don't exist in path\n    // therefore List() should be set manually for some of those keys.\n    this.setEmptyListBeforeEachIndexInPath(path);\n\n    if (allowUndo && path.length <= 1) {\n      this.pushRevertPatchToHistory(path, 'replace');\n    }\n\n    // set new value\n    this.json = this.json.setIn(path, value);\n\n    this.keysStoreService.syncKeysForPath(path, this.json);\n\n    this.json$.next(this.json);\n  }\n\n  private setEmptyListBeforeEachIndexInPath(path: Array<any>) {\n    for (let i = 0; i < path.length - 1; i++) {\n      const currentPath = path.slice(0, i + 1);\n      if (!this.json.hasIn(currentPath) && typeof path[i + 1] === 'number') {\n        this.json = this.json.setIn(currentPath, List());\n      }\n    }\n  }\n\n  getIn(path: Array<any>): any {\n    return this.json.getIn(path);\n  }\n\n  removeIn(path: Array<any>) {\n    this.pushRevertPatchToHistory(path, 'add');\n\n    this.json = this.json.removeIn(path);\n    this.json$.next(this.json);\n    this.keysStoreService.deletePath(path);\n  }\n\n  private pushRevertPatchToHistory(path: Array<any>, revertOp: string) {\n    this.history.push({\n      path: this.pathUtilService.toPathString(path),\n      op: revertOp,\n      value: this.json.getIn(path)\n    });\n  }\n\n  addIn(path: Array<any>, value: any) {\n    const lastPathElement = path[path.length - 1];\n    const isInsert = typeof lastPathElement === 'number' || lastPathElement === '-';\n    if (isInsert) {\n      const pathWithoutIndex = path.slice(0, path.length - 1);\n      let list = this.getIn(pathWithoutIndex) as List<any> || List();\n      value = this.toImmutable(value);\n      if (lastPathElement === '-') {\n        list = list.push(value);\n        path[path.length - 1] = list.size - 1;\n      } else {\n        list = list.insert(lastPathElement, value);\n      }\n      // allowUndo=false to avoid creating replace history patch when adding an item to a list.\n      this.setIn(pathWithoutIndex, list, false);\n    } else {\n      this.setIn(path, value);\n    }\n  }\n\n  private toImmutable(value: any): any {\n    if (typeof value === 'object' && !(List.isList(value) || Map.isMap(value))) {\n      return fromJS(value);\n    }\n    return value;\n  }\n\n  /**\n   * Moves the element at given index UP or DOWN within the list\n   * @param listPath path to a list in json\n   * @param index index of the element that is being moved\n   * @param direction 1 for DOWN, -1 for UP movement\n   * @return new path of the moved element\n   */\n  moveIn(listPath: Array<any>, index: number, direction: number): Array<any> {\n    let list = this.getIn(listPath);\n    let newIndex = index + direction;\n    if (newIndex >= list.size || newIndex < 0) {\n      newIndex = list.size - Math.abs(newIndex);\n    }\n    const temp = list.get(index);\n    list = list\n      .set(index, list.get(newIndex))\n      .set(newIndex, temp);\n    this.setIn(listPath, list);\n\n    this.keysStoreService.swapListElementKeys(listPath, index, newIndex);\n\n    return listPath.concat(newIndex);\n  }\n\n  setJson(json: Map<string, any>) {\n    this.json = json;\n  }\n\n  setJsonPatches(patches: Array<JsonPatch>) {\n    this.patchesByPath = {};\n    patches.forEach(patch => {\n      const path = this.getComponentPathForPatch(patch);\n      if (!this.patchesByPath[path]) {\n        this.patchesByPath[path] = [];\n      }\n      this.patchesByPath[path].push(patch);\n    });\n\n    this.jsonPatches = patches;\n    this.patchesByPath$.next(this.patchesByPath);\n  }\n\n  rollbackLastChange(): string {\n    const lastChangeReversePatch = this.history.pop();\n    if (lastChangeReversePatch) {\n      this.applyPatch(lastChangeReversePatch, false);\n      return lastChangeReversePatch.path;\n    } else {\n      return undefined;\n    }\n  }\n\n  applyPatch(patch: JsonPatch, allowUndo = true) {\n    const path = this.pathUtilService.toPathArray(patch.path);\n    switch (patch.op) {\n      case 'replace':\n        this.setIn(path, patch.value, allowUndo);\n        break;\n      case 'remove':\n        this.removeIn(path);\n        break;\n      case 'add':\n      // custom type for adding a replace patch as new.\n      case 'add-as-new':\n        this.addIn(path, patch.value);\n        break;\n      default:\n        console.warn(`${patch.op} is not supported!`);\n    }\n    this.removeJsonPatch(patch);\n  }\n\n  rejectPatch(patch: JsonPatch) {\n    this.removeJsonPatch(patch);\n  }\n\n  hasPatch(path: string): boolean {\n    return this.patchesByPath[path] && this.patchesByPath[path].length > 0;\n  }\n\n  hasPatchOrChildrenHavePatch(path: string): boolean {\n    if (this.hasPatch(path)) {\n      return true;\n    }\n\n    const childPathPrefix = `${path}${this.pathUtilService.separator}`;\n    return this.jsonPatches\n      .some(patch => patch.path.startsWith(childPathPrefix));\n  }\n\n  private removeJsonPatch(patch: JsonPatch) {\n    const path = this.getComponentPathForPatch(patch);\n    // don't do anything if it's UNDO json-patch.\n    if (this.patchesByPath[path]) {\n      const patchIndex = this.patchesByPath[path].indexOf(patch);\n      if (patchIndex > -1) {\n        this.patchesByPath[path].splice(patchIndex, 1);\n        this.patchesByPath$.next(this.patchesByPath);\n\n        const globalPatchIndex = this.jsonPatches.indexOf(patch);\n        this.jsonPatches.splice(globalPatchIndex, 1);\n        this.jsonPatches$.next(this.jsonPatches);\n      }\n    }\n  }\n\n  private getComponentPathForPatch(patch: JsonPatch): string {\n    if (patch.op === 'add') {\n      // add patches handled by parent component\n      return this.getParentPath(patch.path);\n    }\n    return patch.path;\n  }\n\n  private getParentPath(path: string): string {\n    const pathArray = this.pathUtilService.toPathArray(path);\n    const parentPathArray = pathArray.slice(0, -1);\n    return this.pathUtilService.toPathString(parentPathArray);\n  }\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: PathUtilService, },\n{type: KeysStoreService, },\n];\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}