{"version":3,"sources":["../../../../staging/src/shared/services/record-fixer.service.ts"],"names":[],"mappings":"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","file":"record-fixer.service.js","sourceRoot":"","sourcesContent":["/*\n * This file is part of ng2-json-editor.\n * Copyright (C) 2016 CERN.\n *\n * ng2-json-editor is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License as\n * published by the Free Software Foundation; either version 2 of the\n * License, or (at your option) any later version.\n *\n * ng2-json-editor is distributed in the hope that it will be useful, but\n * WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n * General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with ng2-json-editor; if not, write to the Free Software Foundation, Inc.,\n * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.\n * In applying this license, CERN does not\n * waive the privileges and immunities granted to it by virtue of its status\n * as an Intergovernmental Organization or submit itself to any jurisdiction.\n*/\n\nimport { Injectable } from '@angular/core';\n\nimport { EmptyValueService } from './empty-value.service';\nimport { ComponentTypeService } from './component-type.service';\nimport { JSONSchema } from '../interfaces';\n\n\nexport class RecordFixerService {\n\n  constructor(private emptyValueService: EmptyValueService,\n    private componentTypeService: ComponentTypeService) { }\n\n  /**\n   * Fixes given record according to given schema, in other words\n   * changes it to match the format expected the by te json-editor\n   *\n   * @param rawRecord - json record to be fixed\n   * @param schema - extended schema of rawRecord\n   * @return - fixed record\n   */\n  fixRecord(rawRecord: object, schema: JSONSchema): object {\n    const record = Object.assign({}, rawRecord);\n    Object.keys(record).forEach(field => {\n      if (!schema.properties[field]) {\n        // Delete if field is not in schema!\n        this.deleteField(record, field);\n      } else {\n        // Fix the field and all children.\n        this.fix(field, record, schema.properties[field]);\n      }\n    });\n    return record;\n  }\n\n  /**\n   * Visits all parts of record recursivly, along with the subschema of the part\n   * and apply required fixes.\n   *\n   * NOTE: the reason that parent and key are passed instead of the direct value\n   * is to be able do some operations that needs the parent such as `delete`.\n   *\n   * TODO: add special case for arrays because fixes are the same for\n   * all elements.\n   *\n   * @param key - field name or element index\n   * @param parent - parent of the field/element\n   * @param schema - schema of visited field/element\n   */\n  private fix(key: string | number, parent: object | Array<any>, schema: JSONSchema) {\n    if (schema.hidden) {\n      return;\n    }\n\n    // Fixes for each type/condition, can be added below.\n    const value = parent[key];\n\n    // Recursive calls\n    if (schema.type === 'object') {\n      if (!schema.properties) {\n        throw new Error(`\"${key}\"'s schema has \"type\": \"object\" but doesn't specify \"properties\"`);\n      } else if (!(value instanceof Object)) {\n        throw new Error(`\"${key}\" in ${JSON.stringify(value, null, 2)} is specified as \"object\" by schema but it is not an object in json`);\n      }\n      // Looping over record to filter out fields that are not in schema.\n      Object.keys(value).forEach(prop => {\n        if (!schema.properties[prop]) {\n          // we don't like fields without schema!\n          this.deleteField(value, prop);\n        } else {\n          this.fix(prop, value, schema.properties[prop]);\n        }\n      });\n    } else if (schema.type === 'array') {\n      if (!schema.items) {\n        throw new Error(`\"${key}\"'s schema has \"type\": \"array\" but doesn't specify \"items\"`);\n      } else if (!Array.isArray(value)) {\n        throw new Error(`\"${key}\" in ${JSON.stringify(value, null, 2)} is specified as \"array\" by schema but it is not an array in json`);\n      }\n      value.forEach((element, index) => {\n        this.fix(index, value, schema.items);\n      });\n    }\n  }\n\n  /**\n   * Deletes given field from the given object.\n   * Used for deleting fields that aren't on the schema.\n   *\n   * TODO: replace this with only `delete` when logging is not necessary!\n   */\n  private deleteField(object: object, field: string) {\n    delete object[field];\n    console.warn(`\"${field}\" is removed from input json since it's not in the schema`);\n  }\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: EmptyValueService, },\n{type: ComponentTypeService, },\n];\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}